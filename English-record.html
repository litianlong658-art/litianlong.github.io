<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç”Ÿæ´»è‹±è¯­ â€” å³æ—¶æŸ¥è¯æœ¬ï¼ˆMVPï¼‰</title>
  <style>
    :root{
      --bg:#fbfbfc;
      --card:#fff;
      --muted:#666;
      --accent:#0b84ff;
      --radius:12px;
      font-family: "PingFang SC","Helvetica Neue",Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,#f6f8fb,var(--bg));
      color:#111;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:20px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
    }
    h1{font-size:20px;margin:0}
    .container{max-width:720px;margin:0 auto}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:0 6px 18px rgba(20,30,50,0.06);
      padding:16px;
    }
    .search{
      display:flex;
      gap:8px;
      margin-bottom:12px;
    }
    .search input{
      flex:1;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid #e6e9ee;
      font-size:16px;
    }
    .btn{
      background:var(--accent);
      color:white;
      border:none;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
    }
    .btn.secondary{
      background:transparent;
      color:var(--accent);
      border:1px solid #d7e7ff;
    }
    .result{
      margin-top:14px;
      text-align:center;
      padding:12px;
    }
    .chinese{font-size:20px;margin:6px 0;font-weight:700}
    .english{font-size:28px;margin:6px 0;color:var(--accent);font-weight:700}
    .example{color:var(--muted);margin-top:8px}
    .actions{display:flex;gap:8px;justify-content:center;margin-top:12px}
    .wordlist{margin-top:16px}
    .word-item{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px;border-radius:10px;border:1px solid #f0f2f5;margin-bottom:8px;
    }
    .meta{font-size:12px;color:#888}
    .small{font-size:13px;color:var(--muted)}
    footer{margin-top:20px;text-align:center;color:#999;font-size:13px}
    .tools{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    @media (max-width:420px){
      .english{font-size:22px}
      .chinese{font-size:18px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ç”Ÿæ´»è‹±è¯­ â€” å³æ—¶å•è¯æœ¬ï¼ˆMVPï¼‰</h1>
      <div class="small">MVP Â· æœ¬åœ°å­˜å‚¨</div>
    </header>

    <div class="card">
      <div class="search">
        <input id="chInput" placeholder="è¾“å…¥ä¸­æ–‡ï¼ˆä¾‹å¦‚ï¼šæ¨æ ‘ / æ¡Œå­ / è‹¹æœï¼‰" />
        <button id="lookupBtn" class="btn">æŸ¥è¯¢</button>
      </div>

      <div class="small">ä¹Ÿå¯å…è®¸ä½¿ç”¨â€œè·å–ä½ç½®â€æ¥è®°å½•ä½ åœ¨å“ªé‡Œå­¦åˆ°çš„å•è¯ï¼ˆå¯é€‰ï¼‰</div>

      <div id="result" class="result" style="display:none;">
        <div class="chinese" id="resChinese"></div>
        <div class="english" id="resEnglish"></div>
        <div class="meta" id="resPron"></div>
        <div class="example" id="resExample"></div>

        <div class="actions">
          <button id="speakBtn" class="btn secondary">ğŸ”Š å‘éŸ³</button>
          <button id="saveBtn" class="btn">ğŸ’¾ ä¿å­˜åˆ°å•è¯æœ¬</button>
          <button id="locBtn" class="btn secondary">ğŸ“ è·å–ä½ç½®</button>
        </div>
      </div>

      <div class="tools">
        <button id="showListBtn" class="btn secondary">æŸ¥çœ‹å•è¯æœ¬</button>
        <button id="exportBtn" class="btn">å¯¼å‡º CSV</button>
        <button id="clearAllBtn" class="btn secondary">æ¸…ç©ºå•è¯æœ¬</button>
      </div>

      <div id="wordlist" class="wordlist" style="display:none"></div>
    </div>

    <footer>æç¤ºï¼šè¿™æ˜¯ MVP ç‰ˆã€‚æƒ³è¦ã€Œæ‹ç…§è¯†ç‰©ã€ã€Œåˆ’è¯å–è¯ã€æˆ‘å¯ä»¥åœ¨ä¸‹ä¸€æ­¥å¸®ä½ æ¥å…¥ã€‚</footer>
  </div>

<script>
/*
  MVP åŠŸèƒ½è¯´æ˜ï¼ˆä»£ç å†…æ³¨é‡Šæœ‰è¯´æ˜ï¼‰ï¼š
  - translateChinese(text): ä½¿ç”¨ MyMemory å…è´¹ API è¿›è¡Œ zhâ†’en ç¿»è¯‘
  - å¦‚æœ API å¤±è´¥ä¼šä½¿ç”¨ localFallback å­—å…¸ï¼ˆå¯æ‰©å±•ï¼‰
  - ä¿å­˜é¡¹ï¼š{ch, en, example, createdAt, lat, lng}
  - å­˜å‚¨åœ¨ localStorage é”® 'life_words_v1'
  - å¯¼å‡ºä¸º CSV
  - å‘éŸ³ä½¿ç”¨ SpeechSynthesisï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
*/

// ---------- ç®€å•æœ¬åœ°å›é€€è¯åº“ï¼ˆå¯æ‰©å……ï¼‰ ----------
const localFallback = {
  "æ¨æ ‘": {en:"poplar tree", example:"There are several poplar trees in the park."},
  "æ¡Œå­": {en:"table", example:"Put the book on the table."},
  "è‹¹æœ": {en:"apple", example:"I ate an apple this morning."},
  "ç‹—": {en:"dog", example:"The dog is sleeping under the tree."},
  "æ¤…å­": {en:"chair", example:"Please take a seat on the chair."}
};

// ---------- DOM ----------
const chInput = document.getElementById('chInput');
const lookupBtn = document.getElementById('lookupBtn');
const result = document.getElementById('result');
const resChinese = document.getElementById('resChinese');
const resEnglish = document.getElementById('resEnglish');
const resPron = document.getElementById('resPron');
const resExample = document.getElementById('resExample');
const speakBtn = document.getElementById('speakBtn');
const saveBtn = document.getElementById('saveBtn');
const locBtn = document.getElementById('locBtn');
const showListBtn = document.getElementById('showListBtn');
const wordlist = document.getElementById('wordlist');
const exportBtn = document.getElementById('exportBtn');
const clearAllBtn = document.getElementById('clearAllBtn');

let lastResult = null; // ä¿å­˜æœ€è¿‘æŸ¥è¯¢ç»“æœï¼ˆç”¨äºä¿å­˜åŠ¨ä½œï¼‰
let lastLocation = null; // {lat,lng}

// ---------- Storage helpers ----------
const STORAGE_KEY = 'life_words_v1';
function loadWords(){ 
  try{
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  }catch(e){ return [];}
}
function saveWords(arr){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}

// ---------- ç¿»è¯‘å‡½æ•°ï¼ˆä½¿ç”¨ MyMemory å…è´¹ APIï¼‰ ----------
async function translateChinese(text){
  if(!text || !text.trim()) throw new Error('empty');
  // First try MyMemory API
  const url = 'https://api.mymemory.translated.net/get?q=' + encodeURIComponent(text) + '&langpair=zh|en';
  try{
    const resp = await fetch(url);
    if(!resp.ok) throw new Error('network');
    const data = await resp.json();
    // MyMemory may return translatedText in response.responseData.translatedText
    const trans = data?.responseData?.translatedText || '';
    // sometimes it returns capitalized or sentence-case; keep it simple
    const example = data?.matches?.[0]?.segment ? `${data.matches[0].translation || ''}` : '';
    return {
      en: trans || localFallback[text]?.en || '',
      example: example || (localFallback[text]?.example || (`I see a ${trans || localFallback[text]?.en || text}.`))
    };
  }catch(err){
    // Fallback to local dictionary
    if(localFallback[text]){
      return { en: localFallback[text].en, example: localFallback[text].example};
    }
    // If not found, try a simple rule (word-by-word) using a tiny internal map (very limited)
    const simpleMap = {
      "æ ‘":"tree","èŠ±":"flower","è½¦":"car","æˆ¿å­":"house","çŒ«":"cat","æ‰‹æœº":"phone","æ°´":"water"
    };
    const words = text.replace(/[^\u4e00-\u9fa5]/g,'').split('');
    for(let w of words){
      if(simpleMap[w]){
        return { en: simpleMap[w], example: `This is a ${simpleMap[w]}.` };
      }
    }
    // æœ€åï¼šè¿”å›åŸæ–‡æ‹¼éŸ³å¼å ä½ï¼ˆå¯è®©ç”¨æˆ·ä¿å­˜å¹¶ç¨åç¼–è¾‘ï¼‰
    return { en: text, example: `ï¼ˆæœªæ‰¾åˆ°ç²¾ç¡®ç¿»è¯‘ï¼Œè¯·ç¨åç¼–è¾‘ï¼‰` };
  }
}

// ---------- UI æ“ä½œ ----------
async function doLookup(){
  const text = chInput.value.trim();
  if(!text){ alert('è¯·è¾“å…¥ä¸­æ–‡è¯æ±‡'); return; }
  resChinese.textContent = text;
  resEnglish.textContent = 'æŸ¥è¯¢ä¸­...';
  resPron.textContent = '';
  resExample.textContent = '';
  result.style.display = 'block';

  try{
    const data = await translateChinese(text);
    resEnglish.textContent = data.en || '(æœªæ‰¾åˆ°)';
    resPron.textContent = data.en ? `è‹±è¯­ï¼š${data.en}` : '';
    resExample.textContent = data.example || '';
    lastResult = { ch:text, en:data.en, example:data.example };
  }catch(e){
    resEnglish.textContent = '(æŸ¥è¯¢å¤±è´¥)';
    resExample.textContent = '';
    lastResult = null;
  }
}

async function trySpeak(text){
  if(!('speechSynthesis' in window)){
    alert('ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒ SpeechSynthesisï¼ˆè¯­éŸ³åˆæˆï¼‰ã€‚');
    return;
  }
  const utter = new SpeechSynthesisUtterance(text);
  // å°è¯•è®¾ç½®ä¸ºè‹±è¯­
  utter.lang = 'en-US';
  // å¦‚æœæµè§ˆå™¨æœ‰å¯é€‰ voiceï¼Œå°½é‡æŒ‘é€‰ä¸€ä¸ªè‹±è¯­ voice
  const voices = speechSynthesis.getVoices();
  const enVoice = voices.find(v => v.lang.startsWith('en')) || voices[0];
  if(enVoice) utter.voice = enVoice;
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
}

function renderList(){
  const arr = loadWords();
  if(arr.length === 0){
    wordlist.innerHTML = '<div class="small" style="padding:12px;color:#888">å•è¯æœ¬ä¸ºç©ºã€‚æŸ¥è¯åç‚¹å‡»â€œä¿å­˜åˆ°å•è¯æœ¬â€ä¼šå‡ºç°åœ¨è¿™é‡Œã€‚</div>';
  }else{
    wordlist.innerHTML = '';
    arr.slice().reverse().forEach((item, idx) => {
      const el = document.createElement('div');
      el.className = 'word-item';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:700">${item.ch} â†’ ${item.en}</div>
                        <div class="small">${item.example || ''}</div>
                        <div class="meta">${new Date(item.createdAt).toLocaleString()}${item.lat? ' Â· '+item.lat.toFixed(4)+','+item.lng.toFixed(4):''}</div>`;
      const right = document.createElement('div');
      right.style.display='flex';
      right.style.flexDirection='column';
      right.style.gap='6px';
      const editBtn = document.createElement('button'); editBtn.className='btn secondary'; editBtn.textContent='ç¼–è¾‘';
      const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.textContent='åˆ é™¤';
      editBtn.onclick = ()=> editItem(arr.length - 1 - (arr.slice().reverse().indexOf(item)));
      delBtn.onclick = ()=> deleteItem(arr.length - 1 - (arr.slice().reverse().indexOf(item)));
      right.appendChild(editBtn);
      right.appendChild(delBtn);
      el.appendChild(left);
      el.appendChild(right);
      wordlist.appendChild(el);
    });
  }
  wordlist.style.display = 'block';
}

function saveCurrent(){
  if(!lastResult){
    alert('å…ˆæŸ¥è¯¢ä¸€ä¸ªè¯å†ä¿å­˜ã€‚');
    return;
  }
  const arr = loadWords();
  const item = {
    ch: lastResult.ch,
    en: lastResult.en,
    example: lastResult.example,
    createdAt: Date.now(),
    lat: lastLocation?.lat || null,
    lng: lastLocation?.lng || null
  };
  arr.push(item);
  saveWords(arr);
  alert('å·²ä¿å­˜åˆ°å•è¯æœ¬');
  renderList();
}

function deleteItem(index){
  const arr = loadWords();
  if(index <0 || index >= arr.length) return;
  if(!confirm('ç¡®è®¤åˆ é™¤è¯¥è¯ï¼Ÿ')) return;
  arr.splice(index,1);
  saveWords(arr);
  renderList();
}

function editItem(index){
  const arr = loadWords();
  if(index <0 || index >= arr.length) return;
  const cur = arr[index];
  const newEn = prompt('ç¼–è¾‘è‹±æ–‡ï¼ˆenï¼‰', cur.en);
  if(newEn !== null){
    cur.en = newEn;
    const newEx = prompt('ç¼–è¾‘ä¾‹å¥ï¼ˆexampleï¼‰', cur.example || '');
    if(newEx !== null) cur.example = newEx;
    saveWords(arr);
    renderList();
  }
}

function exportCSV(){
  const arr = loadWords();
  if(arr.length === 0){ alert('å•è¯æœ¬ä¸ºç©º'); return; }
  const rows = [['ä¸­æ–‡','è‹±æ–‡','ä¾‹å¥','æ—¶é—´','lat','lng']];
  arr.forEach(it => rows.push([it.ch, it.en, it.example || '', new Date(it.createdAt).toLocaleString(), it.lat || '', it.lng || '']));
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'life_words_export.csv'; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },5000);
}

// ---------- Location ----------
function getLocationOnce(){
  if(!navigator.geolocation){
    alert('æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®');
    return;
  }
  locBtn.textContent = 'ğŸ“ è·å–ä¸­...';
  navigator.geolocation.getCurrentPosition(pos=>{
    lastLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    locBtn.textContent = 'ğŸ“ å·²è·å–ä½ç½®';
    setTimeout(()=>locBtn.textContent='ğŸ“ è·å–ä½ç½®',1500);
  }, err=>{
    console.warn(err);
    alert('è·å–ä½ç½®å¤±è´¥ï¼š' + err.message);
    locBtn.textContent = 'ğŸ“ è·å–ä½ç½®';
  }, {enableHighAccuracy:false, timeout:10000});
}

// ---------- Events ----------
lookupBtn.addEventListener('click', doLookup);
chInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') doLookup(); });
speakBtn.addEventListener('click', ()=> { if(lastResult) trySpeak(lastResult.en); else alert('å…ˆæŸ¥ä¸€ä¸ªè¯å†å‘éŸ³'); });
saveBtn.addEventListener('click', saveCurrent);
locBtn.addEventListener('click', getLocationOnce);
showListBtn.addEventListener('click', renderList);
exportBtn.addEventListener('click', exportCSV);
clearAllBtn.addEventListener('click', ()=>{
  if(!confirm('ç¡®è®¤æ¸…ç©ºæœ¬åœ°å•è¯æœ¬ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
  localStorage.removeItem(STORAGE_KEY);
  renderList();
});

// åˆå§‹æ¸²æŸ“
renderList();

// ---------- é¢å¤–è¯´æ˜ï¼ˆå¼€å‘è€…å‹å¥½ï¼‰ ----------
/*
  - å¦‚æœä½ æƒ³æ¥å…¥æ›´å¼ºçš„è¯å…¸ï¼ˆä¾‹å¦‚æœ‰æƒå¨é‡Šä¹‰ã€è¯æ€§ã€éŸ³æ ‡ï¼‰ï¼Œ
    æŠŠ translateChinese å‡½æ•°é‡Œå¯¹ MyMemory çš„è°ƒç”¨æ›¿æ¢æˆä½ é€‰çš„ APIï¼ˆLibreTranslate / Youdao / Google Cloud Translationï¼‰ã€‚
    æ³¨æ„ï¼šå¾ˆå¤šå•†ç”¨ API éœ€è¦ API Keyï¼Œå¹¶ä¸”éœ€åœ¨åç«¯ä»£ç†ä»¥é¿å…æ³„éœ²å¯†é’¥ã€‚
  - æ‹ç…§è¯†ç‰©ï¼šå¯ä»¥åœ¨æœªæ¥åŠ ä¸€ä¸ª input type=file accept="image/*"ï¼Œä¸Šä¼ å›¾ç‰‡ç»™åç«¯æˆ–ä½¿ç”¨å‰ç«¯ TF æ¨¡å‹ï¼ˆä¾‹å¦‚ mobilenetï¼‰åšè¯†åˆ«ï¼Œç„¶åæŠŠè¯†åˆ«ç»“æœå½“ä½œä¸­æ–‡æˆ–è‹±æ–‡å»æŸ¥è¯¢ã€‚
  - æƒ³è¦æŠŠè¿™ä¸ªç½‘é¡µæ‰“åŒ…æˆåŸç”Ÿ APPï¼ˆiOS/Androidï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ Capacitor æˆ– Cordova æŠŠç½‘é¡µæ‰“åŒ…ï¼›æˆ–è€…ç”¨ Tauri / Electron åšæ¡Œé¢ç‰ˆã€‚
*/
</script>
</body>
</html>
